# Everything Claude Code — 技术架构文档

> 版本：1.0
> 日期：2026-02-07
> 项目版本：v1.4.1

---

## 1. 架构概览

### 1.1 系统定位

Everything Claude Code (ECC) 是 Claude Code CLI 的增强层，采用**纯配置驱动架构**。系统不包含编译型代码，所有组件通过 Markdown 配置文件 + 轻量 Node.js 脚本实现。

### 1.2 架构风格

```
┌─────────────────────────────────────────────────────────────────┐
│                      Claude Code 主代理                          │
│                   (Anthropic CLI Runtime)                        │
├─────────────────────────────────────────────────────────────────┤
│                    Everything Claude Code                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  Agents   │ │ Commands │ │  Skills  │ │  Rules   │           │
│  │  (13个)   │ │  (30+)   │ │  (30+)   │ │  (24个)  │           │
│  └─────┬────┘ └─────┬────┘ └─────┬────┘ └─────┬────┘           │
│        │             │             │             │                │
│  ┌─────┴─────────────┴─────────────┴─────────────┴────┐         │
│  │                    Hooks 引擎                        │         │
│  │  (PreToolUse / PostToolUse / SessionStart / etc.)   │         │
│  └─────────────────────┬──────────────────────────────┘         │
│                        │                                         │
│  ┌─────────────────────┴──────────────────────────────┐         │
│  │              Scripts (Node.js 工具层)                │         │
│  │  utils.js / package-manager.js / session-manager.js │         │
│  └─────────────────────┬──────────────────────────────┘         │
│                        │                                         │
│  ┌─────────────────────┴──────────────────────────────┐         │
│  │            MCP Servers (外部服务连接)                 │         │
│  │  GitHub / Supabase / Vercel / Railway / etc.        │         │
│  └────────────────────────────────────────────────────┘         │
├─────────────────────────────────────────────────────────────────┤
│                    Plugin 分发系统                                │
│              (.claude-plugin/plugin.json)                         │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 核心设计原则

| 原则 | 说明 | 体现 |
|-----|------|------|
| **配置即代码** | 所有行为通过声明式配置定义 | Markdown + YAML frontmatter |
| **组合优于继承** | 组件独立，通过组合实现复杂功能 | 命令调用代理，代理使用技能 |
| **最小权限** | 每个代理仅授予必要的工具权限 | `tools: ["Read", "Grep"]` |
| **跨平台优先** | 不依赖平台特定功能 | Node.js 脚本替代 Shell 脚本 |
| **零编译** | 分发即可用，无构建步骤 | 纯 Markdown + JavaScript |
| **渐进增强** | 可按需选择安装组件 | 代理/命令/技能/规则独立安装 |

---

## 2. 组件架构

### 2.1 子代理系统（Agent System）

```
┌───────────────────────────────────────────────────────┐
│                   Claude Code 主代理                    │
│                                                        │
│  决策：何时委托？委托给谁？                                │
│  依据：rules/common/agents.md                           │
└────────────┬──────────────────────────────────────────┘
             │ 委托
             ├──→ planner.md          (功能规划)
             ├──→ architect.md        (系统设计)
             ├──→ code-reviewer.md    (代码审查)
             ├──→ security-reviewer.md(安全审查)
             ├──→ tdd-guide.md        (测试驱动开发)
             ├──→ build-error-resolver.md (构建修复)
             ├──→ e2e-runner.md       (端到端测试)
             ├──→ refactor-cleaner.md (重构清理)
             ├──→ doc-updater.md      (文档更新)
             ├──→ go-reviewer.md      (Go 审查)
             ├──→ go-build-resolver.md(Go 构建)
             ├──→ python-reviewer.md  (Python 审查)
             └──→ database-reviewer.md(数据库优化)
```

**代理配置规范：**

```yaml
---
name: agent-name           # kebab-case 标识符
description: 代理职责描述    # 简短描述
tools: ["Read", "Grep"]    # 允许使用的工具列表
model: opus                # 使用的模型（opus/haiku）
---

[代理行为指令（Markdown 正文）]
```

**工具权限矩阵：**

| 代理 | Read | Grep | Glob | Bash | Write | Edit |
|-----|------|------|------|------|-------|------|
| planner | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| architect | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| code-reviewer | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| security-reviewer | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| tdd-guide | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| build-error-resolver | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| e2e-runner | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| refactor-cleaner | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| doc-updater | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |

### 2.2 命令系统（Command System）

```
┌─────────────────────────────────────────────────┐
│              命令分类体系                          │
├─────────────────────────────────────────────────┤
│                                                  │
│  核心工作流命令                                    │
│  ├── /plan        → planner agent               │
│  ├── /tdd         → tdd-guide agent             │
│  ├── /code-review → code-reviewer agent         │
│  ├── /build-fix   → build-error-resolver agent  │
│  ├── /e2e         → e2e-runner agent            │
│  └── /refactor-clean → refactor-cleaner agent   │
│                                                  │
│  验证与评估命令                                    │
│  ├── /verify      → 验证循环                      │
│  ├── /checkpoint  → 状态保存                      │
│  └── /eval        → 评估框架                      │
│                                                  │
│  学习与演化命令                                    │
│  ├── /learn       → 模式提取                      │
│  ├── /skill-create → 技能生成                     │
│  ├── /instinct-*  → 本能管理                      │
│  └── /evolve      → 本能→技能演化                  │
│                                                  │
│  语言特定命令                                      │
│  ├── /go-review   → go-reviewer agent           │
│  ├── /go-test     → Go TDD                      │
│  ├── /go-build    → go-build-resolver agent     │
│  └── /python-review → python-reviewer agent     │
│                                                  │
│  多服务编排命令                                    │
│  ├── /multi-plan  → 任务分解                      │
│  ├── /multi-execute → 协调执行                    │
│  ├── /pm2         → 服务管理                      │
│  └── /orchestrate → 工作流编排                    │
│                                                  │
│  实用工具命令                                      │
│  ├── /sessions    → 会话管理                      │
│  ├── /setup-pm    → 包管理器配置                   │
│  ├── /update-docs → 文档同步                      │
│  ├── /update-codemaps → 代码地图                  │
│  └── /test-coverage → 覆盖率分析                  │
└─────────────────────────────────────────────────┘
```

### 2.3 技能模块系统（Skill System）

```
skills/
├── 工作流技能
│   ├── tdd-workflow/          RED→GREEN→REFACTOR 方法论
│   ├── verification-loop/     持续验证框架
│   ├── eval-harness/          评估框架
│   └── strategic-compact/     策略性上下文压缩
│
├── 编码标准技能
│   ├── coding-standards/      通用编码标准
│   ├── backend-patterns/      后端 API 设计模式
│   ├── frontend-patterns/     React/Next.js 模式
│   └── security-review/       安全检查清单
│
├── 语言特定技能
│   ├── python-patterns/       Python 惯用法
│   ├── python-testing/        pytest 测试模式
│   ├── golang-patterns/       Go 惯用法
│   ├── golang-testing/        Go 测试/基准
│   ├── java-coding-standards/ Java/JVM 最佳实践
│   └── ...
│
├── 框架特定技能
│   ├── django-patterns/       Django MVC 模式
│   ├── django-security/       Django 安全
│   ├── springboot-patterns/   Spring Boot 模式
│   ├── springboot-security/   Spring Boot 安全
│   └── ...
│
├── 数据库技能
│   ├── postgres-patterns/     PostgreSQL 优化
│   ├── clickhouse-io/         ClickHouse 模式
│   └── jpa-patterns/          JPA/Hibernate
│
├── 学习技能
│   ├── continuous-learning/   v1 模式提取
│   ├── continuous-learning-v2/ v2 本能系统
│   └── iterative-retrieval/   渐进式上下文精炼
│
└── 配置技能
    ├── configure-ecc/         安装向导
    └── project-guidelines-example/ 项目指南模板
```

**技能配置规范：**

```yaml
---
name: skill-name
description: 技能描述
version: 1.0.0      # 可选
---

[技能知识内容（Markdown 正文）]
```

### 2.4 规则体系（Rule System）

```
rules/
├── common/                    ← 所有项目必须加载
│   ├── coding-style.md        不可变性、文件组织
│   ├── git-workflow.md        Conventional Commits
│   ├── testing.md             TDD、80% 覆盖率要求
│   ├── performance.md         Token 优化
│   ├── patterns.md            设计模式
│   ├── hooks.md               钩子架构
│   ├── agents.md              何时委托子代理
│   └── security.md            安全检查
│
├── typescript/                ← 按需加载
│   ├── coding-style.md
│   ├── hooks.md
│   ├── patterns.md
│   ├── security.md
│   └── testing.md
│
├── python/                    ← 按需加载
│   └── (同上结构)
│
└── golang/                    ← 按需加载
    └── (同上结构)
```

**规则加载策略：** common/ 目录下的规则始终加载，语言特定规则按项目需要选择安装。

### 2.5 钩子系统（Hook System）

```
┌────────────────────────────────────────────────────────┐
│                    Hook 事件流                           │
├────────────────────────────────────────────────────────┤
│                                                         │
│  SessionStart ──→ session-start.js                     │
│     │               ├── 加载上次会话上下文                │
│     │               └── 检测包管理器                     │
│     ▼                                                   │
│  PreToolUse ──→ 多个条件检查                             │
│     │           ├── 阻止 tmux 外启动 dev server         │
│     │           ├── 提醒使用 tmux 运行长时任务            │
│     │           ├── 阻止意外创建 Markdown 文件            │
│     │           └── 建议上下文压缩                       │
│     ▼                                                   │
│  [工具执行]                                              │
│     │                                                   │
│     ▼                                                   │
│  PostToolUse ──→ 后处理操作                              │
│     │            ├── PR 创建日志记录                     │
│     │            └── 后台分析任务                        │
│     ▼                                                   │
│  PreCompact ──→ pre-compact.js                         │
│                  └── 压缩前保存当前状态                   │
│                                                         │
└────────────────────────────────────────────────────────┘
```

**钩子配置格式（hooks.json）：**

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "command": "node scripts/hooks/check-command.js"
      }
    ],
    "SessionStart": [
      {
        "command": "node scripts/hooks/session-start.js"
      }
    ]
  }
}
```

### 2.6 脚本工具层（Scripts Layer）

```
scripts/
├── lib/                          核心工具库
│   ├── utils.js                  跨平台工具函数
│   │   ├── getProjectRoot()      获取项目根目录
│   │   ├── getECCRoot()          获取 ECC 安装路径
│   │   ├── readJsonFile()        安全读取 JSON
│   │   ├── writeJsonFile()       安全写入 JSON
│   │   └── ensureDir()           确保目录存在
│   │
│   ├── package-manager.js        包管理器抽象
│   │   ├── detectPackageManager() 自动检测
│   │   ├── getInstallCommand()   获取安装命令
│   │   └── getRunCommand()       获取运行命令
│   │
│   ├── session-manager.js        会话生命周期
│   │   ├── saveSession()         保存会话状态
│   │   ├── loadSession()         恢复会话状态
│   │   └── listSessions()        列出历史会话
│   │
│   └── session-aliases.js        会话别名系统
│
├── hooks/                        钩子实现
│   ├── session-start.js          会话启动处理
│   ├── session-end.js            会话结束处理
│   ├── pre-compact.js            压缩前处理
│   ├── suggest-compact.js        智能压缩建议
│   ├── evaluate-session.js       会话模式提取
│   └── check-console-log.js      console.log 检测
│
└── ci/                           CI 验证工具
    ├── validate-agents.js        代理格式验证
    ├── validate-commands.js      命令格式验证
    ├── validate-hooks.js         钩子配置验证
    ├── validate-rules.js         规则结构验证
    └── validate-skills.js        技能格式验证
```

---

## 3. 数据架构

### 3.1 配置数据格式

ECC 使用两种主要数据格式：

**1. Markdown + YAML Frontmatter（代理/命令/技能/规则）**

```markdown
---
name: component-name
description: 组件描述
tools: ["Read", "Grep"]     # 仅代理
model: opus                  # 仅代理
version: 1.0.0              # 仅技能（可选）
---

[Markdown 正文内容]
```

**2. JSON（钩子/插件/MCP 配置）**

```json
{
  "hooks": { ... },
  "agents": [ ... ],
  "skills": [ ... ]
}
```

### 3.2 数据流

```
用户输入 → 命令解析 → 代理选择 → 技能加载 → 规则应用 → 工具执行
                                                            │
                                                            ▼
                                                   钩子触发（Pre/Post）
                                                            │
                                                            ▼
                                                   会话状态持久化
                                                            │
                                                            ▼
                                                   本能提取与演化
```

### 3.3 状态管理

| 状态类型 | 存储位置 | 生命周期 |
|---------|---------|---------|
| 会话上下文 | `~/.claude/sessions/` | 跨会话持久化 |
| 本能知识 | `~/.claude/instincts/` | 永久 |
| 包管理器配置 | `.claude/package-manager.json` | 项目级 |
| 用户偏好 | `~/.claude/CLAUDE.md` | 全局 |
| 项目配置 | `CLAUDE.md` (项目根) | 项目级 |

---

## 4. 集成架构

### 4.1 MCP 服务器集成

```
ECC ──→ MCP Protocol ──→ External Services
         │
         ├── GitHub MCP      → GitHub API (Issues, PRs, Repos)
         ├── Supabase MCP    → PostgreSQL + Auth + Storage
         ├── Vercel MCP      → 部署管理
         ├── Railway MCP     → 服务部署
         ├── Firecrawl MCP   → Web 爬取
         ├── Memory MCP      → 持久化记忆
         ├── Sequential MCP  → 链式推理
         └── Cloudflare MCP  → Workers/KV/D1/R2
```

### 4.2 插件分发架构

```
┌──────────────────────────┐
│    Plugin Marketplace     │
│  (marketplace.json)       │
└────────────┬─────────────┘
             │ 安装
             ▼
┌──────────────────────────┐
│    plugin.json            │
│  ├── agents: [13个]       │
│  ├── skills: [30+]        │
│  └── keywords: [...]      │
└────────────┬─────────────┘
             │ 分发
             ▼
┌──────────────────────────┐
│   用户 ~/.claude/ 目录    │
│  ├── agents/             │
│  ├── commands/           │
│  ├── skills/             │
│  └── rules/ (手动安装)    │
└──────────────────────────┘
```

### 4.3 OpenCode IDE 集成

```
┌─────────────────────────┐
│   OpenCode IDE           │
│  ┌─────────────────────┐│
│  │ .opencode/           ││
│  │ ├── opencode.json    ││ ← 配置入口
│  │ ├── commands/ (24)   ││
│  │ ├── plugins/         ││
│  │ ├── tools/           ││
│  │ └── instructions/    ││
│  └─────────────────────┘│
│                          │
│  共享组件：               │
│  ├── agents/ (12/13)    │
│  ├── skills/ (16/30+)   │
│  └── hooks (完整支持)    │
└─────────────────────────┘
```

---

## 5. 部署架构

### 5.1 安装拓扑

```
方式一：插件市场安装（推荐）
  Marketplace → Plugin System → ~/.claude/

方式二：手动安装
  Git Clone → 手动复制 → ~/.claude/

方式三：交互式安装
  /configure-ecc → 检测环境 → 选择组件 → 自动安装
```

### 5.2 目录结构（用户侧）

```
~/.claude/
├── CLAUDE.md              用户全局配置
├── agents/                子代理定义
│   ├── planner.md
│   ├── code-reviewer.md
│   └── ...
├── commands/              斜杠命令
│   ├── plan.md
│   ├── tdd.md
│   └── ...
├── skills/                技能模块
│   ├── tdd-workflow/
│   ├── backend-patterns/
│   └── ...
├── rules/                 规则文件
│   ├── common/
│   └── typescript/
├── hooks.json             钩子配置
├── sessions/              会话历史
└── instincts/             学习本能
```

---

## 6. 质量保障架构

### 6.1 CI/CD 管道

```
Git Push → GitHub Actions
            │
            ├── validate-agents.js    检查代理 frontmatter
            ├── validate-commands.js  检查命令格式
            ├── validate-hooks.js     检查钩子 JSON
            ├── validate-rules.js     检查规则结构
            ├── validate-skills.js    检查技能格式
            ├── ESLint                JavaScript 代码检查
            ├── Markdownlint          Markdown 格式检查
            └── Commitlint            提交信息规范检查
```

### 6.2 测试策略

```
tests/
├── lib/
│   ├── utils.test.js           单元测试：跨平台工具
│   └── package-manager.test.js 单元测试：包管理器检测
├── hooks/
│   └── hooks.test.js           单元测试：钩子配置
├── integration/
│   └── hooks.test.js           集成测试：钩子执行
└── run-all.js                  测试运行入口
```

---

## 7. 安全架构

### 7.1 安全分层

| 层级 | 机制 | 说明 |
|-----|------|------|
| 代理级 | 工具权限限制 | 只读代理无法写入文件 |
| 钩子级 | PreToolUse 拦截 | 阻止危险操作 |
| 规则级 | 安全规则强制执行 | `security.md` 定义安全检查清单 |
| 技能级 | 安全审查技能 | `security-review/` 提供审查模板 |
| MCP 级 | API Key 隔离 | 敏感凭据通过环境变量注入 |

### 7.2 敏感数据处理

- API Key 不存储在配置文件中，通过环境变量引用
- `.gitignore` 排除 `.env`、凭据文件
- 安全规则要求审查所有涉及凭据的代码变更
