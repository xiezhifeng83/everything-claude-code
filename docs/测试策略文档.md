# Everything Claude Code — 测试策略文档

> 版本：1.0
> 日期：2026-02-07
> 项目版本：v1.4.1

---

## 1. 测试概述

### 1.1 测试目标

ECC 是一个以 Markdown 配置文件为主体的项目，其测试策略侧重于：

1. **配置格式验证** — 确保所有 Markdown/JSON 配置文件格式正确
2. **脚本功能测试** — 验证 Node.js 工具脚本的正确性
3. **跨平台兼容测试** — 确认 Windows/macOS/Linux 行为一致
4. **集成测试** — 验证钩子与主系统的协作

### 1.2 测试分层

```
┌─────────────────────────────────────┐
│         验证层（CI Validators）       │
│  validate-agents / commands / etc.   │
│  格式检查 / 结构验证 / 字段合法性     │
├─────────────────────────────────────┤
│         单元测试层（Unit Tests）       │
│  utils.test.js                       │
│  package-manager.test.js             │
│  hooks.test.js                       │
├─────────────────────────────────────┤
│         集成测试层（Integration）      │
│  hooks.test.js (integration)         │
│  端到端钩子执行验证                    │
├─────────────────────────────────────┤
│         静态分析层（Linting）          │
│  ESLint / Markdownlint / Commitlint │
└─────────────────────────────────────┘
```

---

## 2. 测试类型与覆盖

### 2.1 CI 验证测试

| 验证器 | 文件 | 验证内容 |
|--------|------|---------|
| validate-agents | `scripts/ci/validate-agents.js` | 代理 frontmatter: name, description, tools, model |
| validate-commands | `scripts/ci/validate-commands.js` | 命令 frontmatter: description |
| validate-hooks | `scripts/ci/validate-hooks.js` | hooks.json: JSON 语法, 事件类型, command 非空 |
| validate-rules | `scripts/ci/validate-rules.js` | 规则目录结构, 文件非空 |
| validate-skills | `scripts/ci/validate-skills.js` | SKILL.md 存在, name + description 非空 |

**执行方式：**
```bash
node scripts/ci/validate-agents.js
node scripts/ci/validate-commands.js
node scripts/ci/validate-hooks.js
node scripts/ci/validate-rules.js
node scripts/ci/validate-skills.js
```

### 2.2 单元测试

#### 2.2.1 utils.test.js

**测试目标：** `scripts/lib/utils.js` 跨平台工具函数

| 测试用例 | 验证点 |
|---------|--------|
| getProjectRoot | 正确查找 .git 目录 |
| getProjectRoot (无 .git) | 回退到 CWD |
| getECCRoot | 正确返回 ECC 安装路径 |
| readJsonFile (正常) | 正确解析 JSON |
| readJsonFile (不存在) | 返回 null |
| readJsonFile (非法 JSON) | 返回 null |
| writeJsonFile | 写入并可读取 |
| ensureDir | 递归创建嵌套目录 |
| ensureDir (已存在) | 不报错 |
| normalizePath | Windows/Unix 路径统一 |

#### 2.2.2 package-manager.test.js

**测试目标：** `scripts/lib/package-manager.js` 包管理器检测

| 测试用例 | 验证点 |
|---------|--------|
| 检测 pnpm-lock.yaml | 返回 'pnpm' |
| 检测 yarn.lock | 返回 'yarn' |
| 检测 bun.lockb | 返回 'bun' |
| 检测 package-lock.json | 返回 'npm' |
| 无锁文件 | 返回默认 'npm' |
| 项目配置优先 | 配置覆盖锁文件检测 |
| getInstallCommand('pnpm') | 返回 'pnpm install' |
| getRunCommand('yarn', 'dev') | 返回 'yarn dev' |
| getAddCommand('npm', 'lodash') | 返回 'npm install lodash' |

#### 2.2.3 hooks.test.js（单元）

**测试目标：** `hooks/hooks.json` 配置正确性

| 测试用例 | 验证点 |
|---------|--------|
| JSON 语法正确 | JSON.parse 不报错 |
| 事件类型合法 | 仅含 PreToolUse/PostToolUse/SessionStart/PreCompact |
| 每个钩子有 command | command 字段非空 |
| matcher 值合法 | 匹配已知工具名或未设置 |

### 2.3 集成测试

#### 2.3.1 hooks.test.js（集成）

**测试目标：** 钩子脚本的实际执行

| 测试用例 | 验证点 |
|---------|--------|
| session-start.js 执行 | 正常退出，无错误输出 |
| check-console-log.js (有 console.log) | 输出警告信息 |
| check-console-log.js (无 console.log) | 无输出 |
| suggest-compact.js | 正常退出 |
| pre-compact.js | 正常退出 |

### 2.4 静态分析

#### ESLint 配置

```javascript
// eslint.config.js
export default [
  {
    languageOptions: {
      ecmaVersion: 2022,
      globals: globals.node
    },
    rules: {
      'no-unused-vars': 'error',
      // ...其他规则
    }
  }
];
```

**覆盖范围：** `scripts/**/*.js`, `tests/**/*.js`

#### Markdownlint 配置

```json
// .markdownlint.json
{
  "MD013": false,    // 行长度不限制
  "MD033": false,    // 允许内嵌 HTML
  "MD041": false     // 不要求首行为 H1
}
```

**覆盖范围：** `agents/*.md`, `commands/*.md`, `skills/**/SKILL.md`, `rules/**/*.md`

#### Commitlint 配置

```javascript
// commitlint.config.js
export default {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [2, 'always', [
      'feat', 'fix', 'docs', 'style', 'refactor',
      'perf', 'test', 'chore', 'ci', 'build'
    ]]
  }
};
```

---

## 3. 测试执行

### 3.1 运行全部测试

```bash
# 运行完整测试套件
node tests/run-all.js
```

### 3.2 运行特定测试

```bash
# 单元测试
node tests/lib/utils.test.js
node tests/lib/package-manager.test.js

# 钩子测试
node tests/hooks/hooks.test.js

# 集成测试
node tests/integration/hooks.test.js
```

### 3.3 运行验证器

```bash
# 单个验证器
node scripts/ci/validate-agents.js

# 全部验证器
node scripts/ci/validate-agents.js && \
node scripts/ci/validate-commands.js && \
node scripts/ci/validate-hooks.js && \
node scripts/ci/validate-rules.js && \
node scripts/ci/validate-skills.js
```

### 3.4 运行静态分析

```bash
# ESLint
npx eslint scripts/ tests/

# Markdownlint
npx markdownlint '**/*.md'
```

---

## 4. CI/CD 集成

### 4.1 GitHub Actions 工作流

```yaml
# .github/workflows/validate.yml
name: Validate ECC

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14, 16, 18, 20]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - run: npm ci

      # 格式验证
      - run: node scripts/ci/validate-agents.js
      - run: node scripts/ci/validate-commands.js
      - run: node scripts/ci/validate-hooks.js
      - run: node scripts/ci/validate-rules.js
      - run: node scripts/ci/validate-skills.js

      # 单元测试
      - run: node tests/run-all.js

      # 静态分析
      - run: npx eslint scripts/ tests/
      - run: npx markdownlint '**/*.md'
```

### 4.2 提交检查

通过 commitlint 在提交时验证消息格式：

```
feat: add new Python security skill       ✅
fix: resolve path issue on Windows         ✅
update something                           ❌ (缺少类型前缀)
feat: Add New Feature                      ❌ (首字母大写)
```

---

## 5. 测试覆盖目标

### 5.1 当前覆盖范围

| 组件 | 测试类型 | 覆盖状态 |
|------|---------|---------|
| 代理配置 (13个) | CI 验证 | ✅ 100% |
| 命令配置 (30+) | CI 验证 | ✅ 100% |
| 技能配置 (30+) | CI 验证 | ✅ 100% |
| 规则配置 (24个) | CI 验证 | ✅ 100% |
| 钩子配置 | CI 验证 + 单元测试 | ✅ 100% |
| utils.js | 单元测试 | ✅ 核心函数 |
| package-manager.js | 单元测试 | ✅ 核心函数 |
| session-manager.js | — | ⚠️ 待补充 |
| session-aliases.js | — | ⚠️ 待补充 |
| 钩子脚本 (6个) | 集成测试 | ✅ 基本覆盖 |
| JavaScript 代码 | ESLint | ✅ 100% |
| Markdown 文件 | Markdownlint | ✅ 100% |
| 提交消息 | Commitlint | ✅ 100% |

### 5.2 改进建议

1. **补充 session-manager.js 单元测试** — 测试会话 CRUD 操作
2. **补充 session-aliases.js 单元测试** — 测试别名解析和管理
3. **增加跨平台 CI 矩阵** — 在 Windows/macOS/Linux 上运行测试
4. **添加性能基准测试** — 测量钩子脚本执行时间
5. **端到端安装测试** — 验证完整安装流程在干净环境中可用

---

## 6. 测试编写规范

### 6.1 测试文件命名

```
tests/
├── lib/
│   └── <module-name>.test.js     # 单元测试
├── hooks/
│   └── hooks.test.js             # 钩子测试
└── integration/
    └── <feature>.test.js         # 集成测试
```

### 6.2 测试结构

```javascript
// 使用 Node.js 内置 assert 模块
const assert = require('assert');

// 分组测试
console.log('Testing: <模块名>');

// 单个测试
try {
  const result = functionUnderTest(input);
  assert.strictEqual(result, expected);
  console.log('  ✓ <测试描述>');
} catch (error) {
  console.error('  ✗ <测试描述>:', error.message);
  process.exitCode = 1;
}
```

### 6.3 测试原则

- **每个测试独立** — 不依赖其他测试的执行顺序
- **清理副作用** — 测试结束后清理创建的临时文件
- **明确断言** — 使用 `assert.strictEqual` 而非 `assert.ok`
- **描述性命名** — 测试描述说明"做什么"和"期望什么"
- **边界情况** — 包含空值、非法输入、文件不存在等场景
