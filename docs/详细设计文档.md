# Everything Claude Code — 详细设计文档

> 版本：1.0
> 日期：2026-02-07
> 项目版本：v1.4.1

---

## 1. 设计概述

本文档详细描述 Everything Claude Code 各核心模块的内部设计，包括数据结构、接口规范、算法逻辑和交互流程。

---

## 2. 子代理模块设计

### 2.1 代理定义规范

每个代理由一个独立的 Markdown 文件定义，采用 YAML frontmatter + Markdown body 结构：

**文件位置：** `agents/<agent-name>.md`

**Frontmatter 字段规范：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | string | ✅ | 代理标识符，kebab-case |
| `description` | string | ✅ | 代理职责描述 |
| `tools` | string[] | ✅ | 允许使用的工具列表 |
| `model` | string | ❌ | 使用的模型，默认 `opus` |

**可用工具枚举：**
- `Read` — 读取文件
- `Grep` — 内容搜索
- `Glob` — 文件模式匹配
- `Bash` — 执行命令
- `Write` — 创建/覆盖文件
- `Edit` — 编辑现有文件

**Body 内容结构：** Markdown 格式的行为指令，通常包含：
1. 角色定义
2. 工作流程步骤
3. 输出格式要求
4. 注意事项和约束

### 2.2 代理详细设计

#### 2.2.1 planner（功能规划代理）

**职责：** 将用户需求分解为可执行的实施计划。

**工具权限：** Read, Grep, Glob（只读分析）

**工作流程：**
```
输入: 用户需求描述
  │
  ├── 1. 分析需求，理解目标
  ├── 2. 探索现有代码库结构
  ├── 3. 识别涉及的文件和模块
  ├── 4. 分解为有序的实施步骤
  ├── 5. 评估风险和依赖关系
  └── 6. 输出结构化实施计划
  │
输出: 带步骤编号的实施方案
```

**输出格式：**
```markdown
## 实施计划

### 步骤 1: [步骤标题]
- 修改文件: [文件路径]
- 具体操作: [详细描述]
- 风险评估: [低/中/高]

### 步骤 2: ...
```

#### 2.2.2 code-reviewer（代码审查代理）

**职责：** 对代码变更执行全面的质量和安全审查。

**工具权限：** Read, Grep, Glob, Bash（可运行测试）

**审查维度：**
1. **安全性** — 注入漏洞、认证缺陷、数据泄露
2. **性能** — 算法复杂度、内存使用、N+1 查询
3. **可维护性** — 命名规范、代码结构、注释质量
4. **测试覆盖** — 是否有对应测试、边界情况覆盖
5. **最佳实践** — 设计模式应用、框架惯用法

**输出格式：**
```markdown
## 代码审查报告

### 🔴 严重问题 (CRITICAL)
[必须修复的安全/功能缺陷]

### 🟡 建议改进 (WARNING)
[推荐的代码优化]

### 🟢 良好实践 (GOOD)
[值得肯定的代码亮点]
```

#### 2.2.3 security-reviewer（安全审查代理）

**职责：** 专注于安全漏洞检测。

**工具权限：** Read, Grep, Glob（只读，防止代理修改代码引入新漏洞）

**检查清单（基于 skills/security-review/）：**
1. SQL 注入 / NoSQL 注入
2. XSS（跨站脚本）
3. CSRF（跨站请求伪造）
4. 认证/授权缺陷
5. 敏感数据暴露
6. 不安全的反序列化
7. 已知漏洞的依赖
8. 日志中的敏感信息泄露
9. 文件上传漏洞
10. API 速率限制缺失

#### 2.2.4 tdd-guide（测试驱动开发代理）

**职责：** 引导 RED→GREEN→REFACTOR 工作流。

**工具权限：** Read, Grep, Glob, Bash, Write, Edit（完全权限）

**工作流程：**
```
RED 阶段:
  1. 理解需求
  2. 编写失败的测试
  3. 运行测试，确认失败
  │
GREEN 阶段:
  4. 编写最少的代码使测试通过
  5. 运行测试，确认通过
  │
REFACTOR 阶段:
  6. 优化代码结构
  7. 运行测试，确认仍然通过
  8. 确认覆盖率 ≥ 80%
```

#### 2.2.5 build-error-resolver（构建修复代理）

**职责：** 诊断并修复构建错误。

**工具权限：** Read, Grep, Glob, Bash, Write, Edit

**诊断流程：**
```
1. 解析错误信息
2. 定位错误源文件
3. 分析错误原因（类型错误/缺少依赖/语法错误/配置问题）
4. 生成修复方案
5. 应用修复
6. 重新构建验证
```

---

## 3. 命令模块设计

### 3.1 命令定义规范

**文件位置：** `commands/<command-name>.md`

**Frontmatter 字段：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `description` | string | ✅ | 命令功能描述 |

**Body 内容：** 命令执行时的指令模板，支持动态上下文注入。

### 3.2 核心命令设计

#### 3.2.1 /plan 命令

**触发：** 用户输入 `/plan [需求描述]`

**执行流程：**
```
1. 接收用户需求描述
2. 委托给 planner 代理
3. planner 分析代码库
4. 生成结构化实施计划
5. 返回给用户审批
6. 用户确认后进入实施阶段
```

#### 3.2.2 /tdd 命令

**触发：** 用户输入 `/tdd [功能描述]`

**执行流程：**
```
1. 加载 tdd-workflow 技能
2. 委托给 tdd-guide 代理
3. 进入 RED 阶段（编写测试）
4. 进入 GREEN 阶段（实现功能）
5. 进入 REFACTOR 阶段（优化代码）
6. 验证覆盖率
```

#### 3.2.3 /verify 命令

**触发：** 用户输入 `/verify`

**执行流程：**
```
1. 加载 verification-loop 技能
2. 运行类型检查
3. 运行 linter
4. 运行单元测试
5. 运行集成测试（如有）
6. 检查覆盖率
7. 输出验证报告
8. 如有失败项，循环修复直到全部通过
```

#### 3.2.4 /instinct-status 命令

**触发：** 用户输入 `/instinct-status`

**执行流程：**
```
1. 加载 continuous-learning-v2 技能
2. 读取已存储的本能列表
3. 按领域分组显示
4. 显示每个本能的置信度评分
5. 输出统计摘要
```

#### 3.2.5 /evolve 命令

**触发：** 用户输入 `/evolve`

**执行流程：**
```
1. 读取所有本能
2. 按领域和相似度聚类
3. 识别可合并为技能的本能群
4. 生成新技能/命令草案
5. 用户审批后创建
```

#### 3.2.6 /multi-plan 命令

**触发：** 用户输入 `/multi-plan [任务描述]`

**执行流程：**
```
1. 分析任务涉及的服务
2. 识别服务间依赖关系
3. 分解为并行/串行子任务
4. 为每个子任务分配代理
5. 生成编排计划
```

---

## 4. 技能模块设计

### 4.1 技能定义规范

**文件位置：** `skills/<skill-name>/SKILL.md`

**Frontmatter 字段：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | string | ✅ | 技能标识符 |
| `description` | string | ✅ | 技能功能描述 |
| `version` | string | ❌ | 版本号 |

### 4.2 关键技能详细设计

#### 4.2.1 continuous-learning-v2（本能学习系统）

**核心概念：** 本能（Instinct）是从会话中自动提取的原子化经验。

**本能数据结构：**
```yaml
instinct:
  id: string                    # 唯一标识
  pattern: string               # 模式描述
  confidence: float (0.3-0.9)   # 置信度评分
  domain: string                # 领域标签
  evidence:                     # 证据列表
    - source: string            # 来源会话
      context: string           # 上下文
  created_at: datetime
  updated_at: datetime
```

**置信度评分规则：**
- 0.3 — 初次观察，需更多验证
- 0.5 — 多次观察，趋势明确
- 0.7 — 可靠模式，已在多个场景验证
- 0.9 — 高度可靠，可自动应用

**本能生命周期：**
```
会话中观察 → 提取原子模式 → 初始置信度(0.3)
    │
    ▼
再次观察 → 更新置信度(+0.1~0.2) → 添加证据
    │
    ▼
置信度≥0.7 → 标记为可靠 → 自动应用
    │
    ▼
/evolve → 聚类分析 → 生成技能/命令
```

**领域标签枚举：**
- `code-style` — 编码风格偏好
- `testing` — 测试策略偏好
- `git` — Git 工作流偏好
- `architecture` — 架构设计偏好
- `security` — 安全实践偏好
- `performance` — 性能优化偏好
- `tooling` — 工具使用偏好

#### 4.2.2 tdd-workflow（TDD 工作流技能）

**三阶段设计：**

```
┌──────────────────────────────────────────────┐
│  RED 阶段                                      │
│  ├── 1. 明确需求和预期行为                       │
│  ├── 2. 编写描述预期行为的测试                    │
│  ├── 3. 运行测试 → 必须失败                      │
│  └── 4. 验证测试失败原因正确                     │
├──────────────────────────────────────────────┤
│  GREEN 阶段                                    │
│  ├── 1. 编写最少代码使测试通过                    │
│  ├── 2. 不优化，不重构                           │
│  ├── 3. 运行测试 → 必须通过                      │
│  └── 4. 验证所有已有测试仍通过                    │
├──────────────────────────────────────────────┤
│  REFACTOR 阶段                                 │
│  ├── 1. 优化代码结构和命名                       │
│  ├── 2. 消除重复代码                             │
│  ├── 3. 应用设计模式                             │
│  ├── 4. 运行测试 → 必须全部通过                   │
│  └── 5. 确认覆盖率 ≥ 80%                        │
└──────────────────────────────────────────────┘
```

#### 4.2.3 verification-loop（验证循环技能）

**验证步骤：**
```
1. 类型检查（tsc --noEmit / mypy / go vet）
2. 代码检查（eslint / flake8 / golint）
3. 单元测试（jest / pytest / go test）
4. 集成测试（如存在）
5. 覆盖率检查（≥ 80%）
6. 安全扫描（可选）
```

**循环策略：**
```
验证 → 发现错误 → 修复 → 重新验证 → ...
最大循环次数: 5
退出条件: 全部通过 或 达到最大次数
```

#### 4.2.4 eval-harness（评估框架技能）

**评估维度：**
```
功能正确性:  代码是否满足需求
代码质量:    是否遵循最佳实践
测试覆盖:    测试是否充分
安全合规:    是否存在安全隐患
性能指标:    是否满足性能要求
```

---

## 5. 钩子模块设计

### 5.1 钩子配置格式

**文件位置：** `hooks/hooks.json`

**配置结构：**
```json
{
  "hooks": {
    "<EventType>": [
      {
        "matcher": "<ToolName>",      // 可选，仅匹配特定工具
        "command": "<shell command>",  // 执行的命令
        "timeout": 10000              // 超时时间（ms）
      }
    ]
  }
}
```

**事件类型：**
| 事件 | 触发时机 | 典型用途 |
|------|---------|---------|
| `PreToolUse` | 工具执行前 | 阻止危险操作、提醒 |
| `PostToolUse` | 工具执行后 | 日志、后处理 |
| `SessionStart` | 会话开始时 | 加载上下文、环境检测 |
| `PreCompact` | 上下文压缩前 | 保存状态 |

### 5.2 钩子脚本设计

#### 5.2.1 session-start.js

**功能：** 会话启动时加载上下文。

**处理逻辑：**
```javascript
// 伪代码
async function onSessionStart() {
  // 1. 检测包管理器
  const pm = await detectPackageManager();

  // 2. 加载上次会话上下文（如存在）
  const lastSession = await loadLastSession();

  // 3. 输出上下文提示
  if (lastSession) {
    console.log(`上次会话: ${lastSession.summary}`);
  }

  // 4. 检测项目特殊配置
  const projectConfig = await readProjectConfig();
}
```

#### 5.2.2 suggest-compact.js

**功能：** 基于上下文使用量智能建议压缩。

**策略设计：**
```
Token 使用率 < 50%  → 不建议
Token 使用率 50-70% → 软提醒
Token 使用率 > 70%  → 强烈建议
Token 使用率 > 85%  → 紧急提醒
```

#### 5.2.3 check-console-log.js

**功能：** 检测代码中的 console.log 语句。

**处理逻辑：**
```
1. 获取当前编辑的文件路径
2. 检查是否为 JS/TS 文件
3. 扫描新增/修改行
4. 发现 console.log → 发出警告
5. 排除：测试文件、配置文件
```

---

## 6. 脚本工具库设计

### 6.1 utils.js — 跨平台工具

**核心函数：**

| 函数 | 参数 | 返回 | 说明 |
|------|------|------|------|
| `getProjectRoot()` | 无 | string | 查找最近的 git 根目录 |
| `getECCRoot()` | 无 | string | 获取 ECC 安装路径 |
| `readJsonFile(path)` | 文件路径 | object\|null | 安全读取 JSON |
| `writeJsonFile(path, data)` | 路径, 数据 | void | 安全写入 JSON |
| `ensureDir(path)` | 目录路径 | void | 递归创建目录 |
| `normalizePath(path)` | 路径 | string | 标准化路径分隔符 |

**跨平台策略：**
- 路径分隔符统一使用 `path.join()` / `path.resolve()`
- 文件操作使用 `fs.promises` API
- 环境变量通过 `process.env` 读取
- 不使用 Shell 特定语法

### 6.2 package-manager.js — 包管理器抽象

**检测优先级：**
```
1. 项目级配置（.claude/package-manager.json）
2. 锁文件检测：
   - pnpm-lock.yaml  → pnpm
   - yarn.lock       → yarn
   - bun.lockb       → bun
   - package-lock.json → npm
3. 全局配置
4. 默认: npm
```

**命令映射：**

| 操作 | npm | pnpm | yarn | bun |
|------|-----|------|------|-----|
| 安装依赖 | `npm install` | `pnpm install` | `yarn` | `bun install` |
| 添加包 | `npm install <pkg>` | `pnpm add <pkg>` | `yarn add <pkg>` | `bun add <pkg>` |
| 运行脚本 | `npm run <s>` | `pnpm <s>` | `yarn <s>` | `bun run <s>` |
| 开发依赖 | `--save-dev` | `--save-dev` | `--dev` | `--dev` |

### 6.3 session-manager.js — 会话管理

**会话数据结构：**
```json
{
  "id": "session-uuid",
  "alias": "feature-login",
  "created_at": "2026-02-07T10:00:00Z",
  "updated_at": "2026-02-07T12:30:00Z",
  "context": {
    "working_files": ["src/auth.ts", "src/login.tsx"],
    "recent_commands": ["/plan", "/tdd"],
    "active_instincts": ["prefer-zod-validation"]
  }
}
```

**生命周期管理：**
```
SessionStart → 创建/恢复会话 → 会话运行中 → 手动/自动保存 → SessionEnd
                                  ↕
                            PreCompact → 保存快照
```

---

## 7. CI 验证脚本设计

### 7.1 验证器通用接口

每个验证脚本遵循相同模式：

```javascript
// 伪代码
async function validate() {
  const files = await glob(pattern);     // 查找目标文件
  const errors = [];

  for (const file of files) {
    const content = await readFile(file);
    const frontmatter = parseFrontmatter(content);

    // 检查必填字段
    if (!frontmatter.name) errors.push(`${file}: 缺少 name 字段`);
    if (!frontmatter.description) errors.push(`${file}: 缺少 description 字段`);

    // 特定检查...
  }

  if (errors.length > 0) {
    console.error('验证失败:');
    errors.forEach(e => console.error(`  ✗ ${e}`));
    process.exit(1);
  }

  console.log('✓ 验证通过');
}
```

### 7.2 各验证器特殊规则

| 验证器 | 检查项 |
|--------|--------|
| validate-agents | name, description, tools 为合法值, model 为 opus/haiku |
| validate-commands | description 非空 |
| validate-hooks | JSON 语法正确, 事件类型合法, command 非空 |
| validate-rules | 目录结构正确, 文件非空 |
| validate-skills | SKILL.md 存在, name + description 非空 |

---

## 8. 插件系统设计

### 8.1 plugin.json 结构

```json
{
  "name": "everything-claude-code",
  "version": "1.4.1",
  "description": "Production-ready Claude Code configurations",
  "agents": [
    {
      "name": "planner",
      "path": "agents/planner.md"
    }
    // ... 13 个代理
  ],
  "skills": [
    {
      "name": "tdd-workflow",
      "path": "skills/tdd-workflow"
    }
    // ... 30+ 技能
  ],
  "keywords": ["claude-code", "productivity", "tdd", "agents"]
}
```

### 8.2 marketplace.json 结构

```json
{
  "name": "everything-claude-code",
  "displayName": "Everything Claude Code",
  "publisher": "affaan-m",
  "version": "1.4.1",
  "categories": ["Productivity", "Testing", "Code Quality"],
  "installs": 0,
  "rating": 0
}
```

### 8.3 分发流程

```
开发者 → 更新 plugin.json → 发布到 Marketplace
                                    │
用户 → /plugin marketplace search → 发现 → 安装 → ~/.claude/
```

---

## 9. 错误处理设计

### 9.1 脚本错误处理策略

```javascript
// 统一错误处理模式
try {
  const result = await operation();
} catch (error) {
  if (error.code === 'ENOENT') {
    // 文件不存在 — 静默跳过或创建默认值
  } else if (error.code === 'EACCES') {
    // 权限错误 — 输出明确提示
    console.error(`权限不足: ${error.path}`);
  } else {
    // 未知错误 — 记录并安全退出
    console.error(`未知错误: ${error.message}`);
    process.exit(1);
  }
}
```

### 9.2 验证错误报告格式

```
[FAIL] agents/planner.md
  ✗ 缺少必填字段: tools
  ✗ model 值无效: "gpt-4"（允许: opus, haiku）

[PASS] agents/code-reviewer.md ✓
```

---

## 10. 国际化设计

### 10.1 翻译文件组织

```
docs/
├── zh-CN/                 简体中文
│   ├── agents/            代理翻译
│   ├── commands/          命令翻译
│   ├── skills/            技能翻译
│   └── rules/             规则翻译
└── zh-TW/                 繁体中文
    └── (同上结构)
```

### 10.2 翻译策略

- README 提供完整翻译版本
- 代理/命令/技能的描述提供翻译
- 代码示例保持英文不翻译
- 技术术语首次出现时标注英文原文
